# Environment Configuration

This document summarizes core configuration across local, test, and production environments, including binding names, deploy branches, and required secrets.

## Environments Overview

| Environment | Config file          | Database name                      | R2 binding | KV binding | Branch                | Key command                  |
| ----------- | -------------------- | ---------------------------------- | ---------- | ---------- | --------------------- | ---------------------------- |
| Local dev   | `wrangler.toml`      | `cloudflare-worker-template-local` | `BUCKET`   | `KV`       | manual                | `pnpm run cf:dev`            |
| Test        | `wrangler.test.toml` | `cloudflare-worker-template-test`  | `BUCKET`   | `KV`       | `develop` / `preview` | `pnpm run pages:deploy:test` |
| Production  | `wrangler.prod.toml` | `cloudflare-worker-template-prod`  | `BUCKET`   | `KV`       | `main`                | `pnpm run pages:deploy:prod` |

> ðŸ“Œ Note: Cloudflare Pages and Workers inject env vars based on bindings in `wrangler.*.toml`. Code reads `process.env.BUCKET`, `process.env.DB`, and `process.env.KV`. Keep names consistent.

## Required Secrets

Define the following secrets in repository **Settings â†’ Secrets and variables â†’ Actions** so that CI/CD workflows can create databases, run migrations, and deploy pages:

| Name                    | Purpose                                                          |
| ----------------------- | ---------------------------------------------------------------- |
| `CLOUDFLARE_API_TOKEN`  | Authorize Wrangler to create/migrate D1, R2, KV and deploy Pages |
| `CLOUDFLARE_ACCOUNT_ID` | Identify the Cloudflare account for Wrangler API calls           |

Add extra thirdâ€‘party secrets here and reference them in `[vars]` of `wrangler.*.toml`.

## Bindings Checklist

- D1: Confirm `database_name` matches the table; remote environments require real `database_id`.
- R2: Binding must be `BUCKET`, otherwise `createR2Client()` returns `null`.
- KV: Binding must be `KV`, consistent with cache client.
- Vars: Set optional `ENVIRONMENT`, `RATE_LIMIT_*`, `LOG_LEVEL` in `[vars]`.

## Analytics Backend Selection (fallbacks)

Select the Analytics event sink backend via environment variables:

- `ANALYTICS_ENABLED`: `true|false` (default `true`)
- `ANALYTICS_SINK`: `log|kv|d1|engine` (default `log`)

Recommendations:

- Dev/Test: `ANALYTICS_SINK=log` (or `kv` for lightweight counts)
- Production: prefer `engine`; on failure fallback to logs. For structured retention, `d1` with migration tables.

Notes:

- `kv` mode only accumulates counts per event type + date
- `engine` mode requires a binding; without it, falls back to logs

## Analytics Engine Binding Example (production)

Add Analytics Engine dataset binding in `wrangler.prod.toml` and select `engine` as the backend in environment variables:

```toml
[vars]
ENVIRONMENT = "production"
ANALYTICS_SINK = "engine"

[[analytics_engine_datasets]]
binding = "ANALYTICS"                 # Code accesses via env.ANALYTICS
dataset = "your-analytics-dataset"    # Replace with actual dataset name
```

Code retrieves binding via `getAnalyticsEngine()`:

```ts
import { getAnalyticsEngine } from '@/lib/analytics';

const engine = getAnalyticsEngine();
await engine?.writeDataPoint({
  blobs: [
    /* string columns */
  ],
  doubles: [
    /* numeric columns */
  ],
  indexes: [
    /* index columns */
  ],
});
```

Note: Without binding or on write failure, system falls back to logs.

## Data Initialization

Use the script `scripts/seed.js` to inject sample data into the database:

```bash
# Local (Wrangler uses local SQLite file)
pnpm run db:seed -- --env=local

# Test environment (requires remote database and Cloudflare credentials)
pnpm run db:seed -- --env=test

# Production environment (use with caution)
pnpm run db:seed -- --env=prod
```

The script autoâ€‘matches DB name and args; unsupported env exits with a message.

## Preâ€‘Deployment Checks

1. `pnpm test && pnpm run type-check && pnpm run format:check`
2. Did local or remote migration commands (`pnpm run db:migrate:local`) succeed?
3. Are all Cloudflare bindings created in the Dashboard?
4. Are secrets configured?
5. Are versions and CHANGELOG generated by `release-please` as expected?

Keep this checklist current to help contributors and ops onboard and troubleshoot.
